var K=Object.defineProperty;var q=(e,t,o)=>t in e?K(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var L=(e,t,o)=>q(e,typeof t!="symbol"?t+"":t,o);import{b as y,j as n,R as N,c as B}from"./client.js";const P=y.createContext(null);function R(){const e=y.useContext(P);if(!e)throw new Error("LineContext must be used inside a provider");return e}function U(e){const t=new Map,o=new Map;function l(s,g=null,d="",p=0){if(s)switch(t.set(s.id,s),g&&o.set(s.id,{parent:g,key:d,index:p}),s.type){case"functionDeclaration":{const a=s;a.parameterList.forEach((j,m)=>l(j,a,"parameterList",m));break}case"functionDefinition":{const a=s;a.parameterList.forEach((j,m)=>l(j,a,"parameterList",m)),l(a.compoundStatement,s,"compoundStatement",0);break}case"compoundStatement":{s.codeBlock.forEach((j,m)=>l(j,s,"codeBlock",m));break}case"declaration":{const a=s;a.value&&l(a.value,a,"value",0);break}case"returnStatement":{const a=s;a.value&&l(a.value,a,"value",0);break}case"callExpression":{const a=s;a.argumentList.forEach((j,m)=>l(j,a,"argumentList",m));break}case"assignmentExpression":{l(s.value,s,"value",0);break}}}return e.forEach(s=>l(s)),{nodeMap:t,parentMap:o}}function v(e,t,o=0){return{parent:e,key:t,index:o}}function O(){const{mode:e}=R();return n.jsxs("div",{style:{position:"fixed",top:"10px",right:"10px",padding:"5px 10px",backgroundColor:e==="view"?"var(--vscode-editorInfo-background)":"var(--vscode-editorWarning-background)",color:e==="view"?"var(--vscode-editorInfo-foreground)":"var(--vscode-editorWarning-foreground)",border:"1px solid "+(e==="view"?"var(--vscode-editorInfo-border)":"var(--vscode-editorWarning-border)"),borderRadius:"3px",fontSize:"12px",fontWeight:"bold",zIndex:1e3},children:["MODE: ",e.toUpperCase()]})}function k({node:e,key:t,parentInfo:o,className:l}){const{selectedNodeId:s,selectedKey:g,onEdit:d,setSelectedNodeId:p,setSelectedKey:a,setParentNodeInfo:j,focusRequest:m,clearFocusRequest:E,mode:w,setMode:f}=R(),u=s==e.id&&g&&g==t,[r,i]=N.useState(String(e[t]??"")),c=N.useRef(null),x=N.useRef(!1);N.useEffect(()=>{i(String(e[t]??""))},[e,t]),N.useEffect(()=>{m&&m.nodeId===e.id&&m.fieldKey===t&&!x.current&&c.current&&(c.current.focus(),c.current.select(),x.current=!0,E()),m||(x.current=!1)},[m,e.id,t,E]);const h=b=>{b.key==="i"&&w==="view"?(b.preventDefault(),f("edit")):b.key==="Escape"&&w==="edit"&&(b.preventDefault(),f("view"))},S=Math.max(1,r.length)+"ch";return n.jsx("input",{ref:c,className:`inline-editor ${l??""}`,style:{...u?{backgroundColor:"rgba(255, 255, 255, 0.05)",boxShadow:"inset 0 -1px 0 0 rgba(163, 209, 252, 0.5)"}:{},width:S},value:r,onChange:b=>i(b.target.value),onKeyDown:h,onFocus:()=>{a(t),p(e.id),j(o)},onBlur:()=>{e[t]=r,d(e,t)},readOnly:w==="view"})}function M({node:e,children:t,display:o="block"}){const{selectedNodeId:l,setSelectedNodeId:s,onEdit:g,nodeMap:d,parentMap:p,requestFocus:a,mode:j}=R(),m=l===e.id,E=r=>{m&&(r.key==="Enter"&&j==="view"?(r.preventDefault(),f()):r.key==="Delete"&&j==="view"&&(r.preventDefault(),w()))},w=()=>{console.log("Deleting node:",e);const r=p.get(e.id);if(!r)return;const{parent:i,key:c,index:x}=r;if(!i||!(c in i))return;const h=i[c];if(Array.isArray(h)){console.log("Parent field is an array, removing from array");const S=[...h.slice(0,x),...h.slice(x+1)];i[c]=S,d.delete(e.id),p.delete(e.id);for(let b=0;b<S.length-x;b++){const C=S[x+b];C&&typeof C=="object"&&"id"in C&&p.set(C.id,{parent:i,key:c,index:x+b})}g(i,c),console.log("Deleted node:",e.id," from parent:",i," at key:",c," index:",x)}else typeof h=="object"?(console.log("Parent field is single-valued, setting to null"),i[c]=null,d.delete(e.id),p.delete(e.id),g(i,c),console.log("Deleted node:",e.id," from parent:",i," at key:",c)):console.error("Parent field is neither array nor object, cannot delete")},f=()=>{const r={id:crypto.randomUUID(),type:"unknown",content:""},i=p.get(e.id);if(!i)return;const{parent:c,key:x,index:h}=i;if(!c||!(x in c))return;const S=c[x];if(!Array.isArray(S))return;const b=[...S.slice(0,h+1),r,...S.slice(h+1)];c[x]=b,d.set(r.id,r),p.set(r.id,{parent:c,key:x,index:h+1}),g(c,x),console.log("Inserted new unknown node:",r," in parent:",c," at key:",x," index:",h),a(r.id,"content")},u=o==="inline"?"span":"div";return n.jsx(u,{onKeyDown:E,className:`object-container object-container-${o} ${m?"object-selected":""}`,onClick:r=>{r.stopPropagation(),s(e.id)},tabIndex:0,children:t})}function I({node:e,parentInfo:t}){switch(e.type){case"preprocInclude":return n.jsx(T,{includeDecl:e,parentInfo:t});case"functionParameter":return n.jsx(A,{paramDecl:e,parentInfo:t});case"functionDeclaration":return n.jsx(V,{functionDeclaration:e,parentInfo:t});case"functionDefinition":return n.jsx(z,{funcDef:e,parentInfo:t});case"declaration":return n.jsx($,{varDecl:e,parentInfo:t});case"returnStatement":return n.jsx(H,{returnStmt:e,parentInfo:t});case"compoundStatement":return n.jsx(F,{compoundStatement:e,parentInfo:t});case"callExpression":return n.jsx(Q,{callExpr:e,parentInfo:t});case"reference":return n.jsx(X,{reference:e,parentInfo:t});case"assignmentExpression":return n.jsx(Y,{assignmentExpr:e,parentInfo:t});case"numberLiteral":return n.jsx(Z,{literalExpr:e,parentInfo:t});case"stringLiteral":return n.jsx(_,{literalExpr:e,parentInfo:t});case"binaryExpression":return n.jsx(ee,{binaryExpression:e,parentInfo:t});case"ifStatement":return n.jsx(J,{ifStatement:e});case"unknown":return n.jsx(W,{unknown:e,parentInfo:t});default:return"WIP"}}function W({unknown:e,parentInfo:t}){const{mode:o,onRequestAvailableInserts:l,availableInserts:s,onEdit:g}=R(),[d,p]=N.useState(!1),a=N.useRef(null),j=f=>{if(f.key==="Enter"&&o==="edit"){f.preventDefault(),console.log("Requesting available inserts for unknown node:",e);const u=t.parent,r=t.key;l(u.id,r),p(!0)}else f.key==="Escape"&&d&&(f.preventDefault(),p(!1))};N.useEffect(()=>{d&&s&&s.length>0&&a.current&&a.current.focus()},[d,s]);const m=()=>{if(!a.current){console.log("Dropdown ref not set");return}const f=parseInt(a.current.value);if(s&&f>=0){const u=s[f],r=t.parent,i=t.key,c=t.index;if(console.log("Parent before insert:",r," key:",i," index:",c),console.log("Selected option to insert:",u),Array.isArray(r[i])){console.log("Inserting into array field");const h=[...r[i]];h[c]=u,r[i]=h,console.log("Parent after insert:",r),g(r,i)}else typeof r[i]=="object"?(console.log("Parent field is single-valued, replacing directly"),r[i]=u,console.log("Parent after insert:",r),g(r,i)):console.error("Parent field is neither array nor object, cannot insert");p(!1)}},E=f=>{f.key==="Enter"?(f.preventDefault(),f.stopPropagation(),m()):f.key==="Escape"&&(f.preventDefault(),p(!1))},w=()=>{m()};return n.jsxs("span",{onKeyDown:j,children:[k({node:e,key:"content",parentInfo:t}),d&&s&&s.length>0&&n.jsxs("select",{ref:a,onKeyDown:E,onClick:w,onBlur:()=>p(!1),size:Math.min(10,s.length),style:{position:"absolute",zIndex:1e3,backgroundColor:"var(--vscode-dropdown-background)",color:"var(--vscode-dropdown-foreground)",border:"1px solid var(--vscode-dropdown-border)"},children:[n.jsx("option",{value:"-1",children:"-- Select an option --"}),s.map((f,u)=>n.jsx("option",{value:u,children:f.type},u))]})]})}function T({includeDecl:e,parentInfo:t}){return n.jsxs(n.Fragment,{children:[n.jsx("span",{className:"token-keyword",children:"#include"})," ",k({node:e,key:"content",parentInfo:t,className:"token-string"})]})}function V({functionDeclaration:e,parentInfo:t}){const{nodeMap:o}=R();return o.set(e.id,e),n.jsxs(n.Fragment,{children:[k({node:e,key:"returnType",parentInfo:t,className:"token-type"}),k({node:e,key:"identifier",parentInfo:t,className:"token-function"}),n.jsx("span",{className:"token-delimiter",children:"("}),e.parameterList.map((l,s)=>n.jsxs(N.Fragment,{children:[s>0&&", ",n.jsx(A,{paramDecl:l,parentInfo:v(e,"parameterList",s)})]},l.id)),n.jsx("span",{className:"token-delimiter",children:")"})]})}function z({funcDef:e,parentInfo:t}){const{nodeMap:o}=R();return o.set(e.id,e),n.jsxs(n.Fragment,{children:[k({node:e,key:"returnType",parentInfo:t,className:"token-type"})," ",k({node:e,key:"identifier",parentInfo:t,className:"token-function"}),n.jsx("span",{className:"token-delimiter",children:"("}),e.parameterList.map((l,s)=>n.jsxs(N.Fragment,{children:[s>0&&", ",n.jsx(A,{paramDecl:l,parentInfo:v(e,"parameterList",s)})]},l.id)),n.jsx("span",{className:"token-delimiter",children:")"}),e.compoundStatement&&n.jsx(F,{compoundStatement:e.compoundStatement,parentInfo:v(e,"compoundStatement")})]})}function $({varDecl:e,parentInfo:t}){const{nodeMap:o,onEdit:l,mode:s}=R();o.set(e.id,e);const g=d=>{if(s==="edit"&&d.key==="Enter"&&!e.value){d.preventDefault();const p={id:crypto.randomUUID(),type:"unknown",content:""};e.value=p,o.set(p.id,p),l(e,null),console.log("Inserted unknown node as value for declaration:",e.id)}};return n.jsxs("span",{onKeyDown:g,children:[k({node:e,key:"primitiveType",parentInfo:t,className:"token-type"})," ",k({node:e,key:"identifier",parentInfo:t,className:"token-variable"}),e.value&&n.jsxs(n.Fragment,{children:[" ","="," ",n.jsx(M,{node:e.value,display:"inline",children:n.jsx(I,{node:e.value,parentInfo:v(e,"value")})})]}),";"]})}function A({paramDecl:e,parentInfo:t}){const{nodeMap:o}=R();return o.set(e.id,e),n.jsxs(n.Fragment,{children:[k({node:e,key:"paramType",parentInfo:t,className:"token-type"})," ",k({node:e,key:"identifier",parentInfo:t,className:"token-variable"})]})}function F({compoundStatement:e}){return n.jsxs(n.Fragment,{children:[n.jsx("span",{className:"token-delimiter",children:"{"}),n.jsx("div",{style:{display:"flex",flexDirection:"column",paddingLeft:"20px"},children:e.codeBlock.map((t,o)=>n.jsx(M,{node:t,children:n.jsx(I,{node:t,parentInfo:v(e,"codeBlock",o)})},t.id))}),n.jsx("span",{className:"token-delimiter",children:"}"})]})}function J({ifStatement:e}){return n.jsxs(n.Fragment,{children:[n.jsx("span",{className:"token-keyword",children:"if"})," ",n.jsx("span",{className:"token-keyword",children:"("}),n.jsx(I,{node:e.condition,parentInfo:v(e,"condition")}),n.jsx("span",{className:"token-keyword",children:")"})," ",n.jsx(F,{compoundStatement:e.compoundStatement,parentInfo:v(e,"compoundStatement")}),e.elseClause&&n.jsx(G,{elseClause:e.elseClause})]})}function G({elseClause:e}){return n.jsxs(n.Fragment,{children:[" ",n.jsx("span",{className:"token-keyword",children:"else"})," ",n.jsx(F,{compoundStatement:e.compoundStatement,parentInfo:v(e,"compoundStatement")})]})}function H({returnStmt:e}){return n.jsxs(n.Fragment,{children:[n.jsx("span",{className:"token-keyword",children:"return"}),e.value&&n.jsxs(n.Fragment,{children:[" ",n.jsx(I,{node:e.value,parentInfo:v(e,"value")})]}),";"]})}function Q({callExpr:e,parentInfo:t}){return n.jsxs(n.Fragment,{children:[k({node:e,key:"identifier",parentInfo:t,className:"token-function"}),n.jsx("span",{className:"token-delimiter",children:"("}),e.argumentList.map((o,l)=>n.jsxs(N.Fragment,{children:[l>0&&", ",n.jsx(I,{node:o,parentInfo:v(e,"argumentList",l)})]},o.id)),n.jsx("span",{className:"token-delimiter",children:")"}),";"]})}function X({reference:e}){const{nodeMap:t}=R(),o=t.get(e.declarationId);return!o||!("identifier"in o)?n.jsx(n.Fragment,{children:e.declarationId}):n.jsx("span",{className:"token-variable",children:String(o.identifier)})}function Y({assignmentExpr:e}){const{nodeMap:t}=R(),o=t.get(e.idDeclaration);return!o||!("identifier"in o)?n.jsx(n.Fragment,{children:e.idDeclaration}):n.jsxs(n.Fragment,{children:[n.jsx("span",{className:"token-variable",children:String(o.identifier)})," ","="," ",n.jsx(I,{node:e.value,parentInfo:v(e,"value")})]})}function Z({literalExpr:e,parentInfo:t}){return n.jsx(n.Fragment,{children:k({node:e,key:"value",parentInfo:t,className:"token-number"})})}function _({literalExpr:e,parentInfo:t}){return n.jsxs(n.Fragment,{children:[n.jsx("span",{className:"token-string",children:'"'}),k({node:e,key:"value",parentInfo:t,className:"token-string"}),n.jsx("span",{className:"token-string",children:'"'})]})}function ee({binaryExpression:e,parentInfo:t}){return n.jsxs(n.Fragment,{children:[n.jsx(I,{node:e.left,parentInfo:v(e,"left")})," ",k({node:e,key:"operator",parentInfo:t})," ",n.jsx(I,{node:e.right,parentInfo:v(e,"right")})]})}function ne({sourceFile:e,onEdit:t,onRequestAvailableInserts:o,availableInserts:l,selectedNodeId:s,selectedKey:g,parentNodeInfo:d,setSelectedNodeId:p,setSelectedKey:a,setParentNodeInfo:j,children:m}){const{nodeMap:E,parentMap:w}=y.useMemo(()=>U(e.code),[e]),[f,u]=y.useState(null),[r,i]=y.useState("view"),c=y.useCallback((h,S)=>{u({nodeId:h,fieldKey:S})},[]),x=y.useCallback(()=>{u(null)},[]);return n.jsx(P.Provider,{value:{onEdit:t,onRequestAvailableInserts:o,availableInserts:l,selectedNodeId:s,selectedKey:g,parentNodeInfo:d,setParentNodeInfo:j,setSelectedNodeId:p,setSelectedKey:a,nodeMap:E,parentMap:w,focusRequest:f,requestFocus:c,clearFocusRequest:x,mode:r,setMode:i},children:m})}class te{constructor(){L(this,"vsCodeApi");typeof acquireVsCodeApi=="function"&&(this.vsCodeApi=acquireVsCodeApi())}postMessage(t){this.vsCodeApi?this.vsCodeApi.postMessage(t):console.log(t)}getState(){if(this.vsCodeApi)return this.vsCodeApi.getState();{const t=localStorage.getItem("vscodeState");return t?JSON.parse(t):void 0}}setState(t){return this.vsCodeApi?this.vsCodeApi.setState(t):(localStorage.setItem("vscodeState",JSON.stringify(t)),t)}}const D=new te,se=y.createContext(null);function re({debug:e,children:t}){return n.jsx(se.Provider,{value:{debug:e},children:t})}function oe(){const[e,t]=y.useState(void 0),[o,l]=y.useState(null),[s,g]=y.useState(null),[d,p]=y.useState(null),[a,j]=y.useState(null),[m,E]=y.useState(!1);y.useEffect(()=>{const u=r=>{console.log("event:",r);const i=r.data;console.log("message:",i),i.type==="update"?t(i.contents):i.type==="availableInserts"?j(i.contents):i.type==="toggleDebug"&&(console.log("Toggling debug mode"),E(c=>!c))};return window.addEventListener("message",u),D.postMessage({type:"ready"}),()=>{window.removeEventListener("message",u)}},[]);const w=(u,r)=>{const i={type:"nodeEdit",contents:u,key:r};t(c=>c&&{...c}),console.log("sending message: ",i),D.postMessage(i)},f=(u,r)=>{const i={type:"requestAvailableInserts",nodeId:u,nodeKey:r};console.log("requesting available inserts: ",i),D.postMessage(i)};return n.jsx(n.Fragment,{children:n.jsxs(re,{debug:m,children:[e?n.jsxs(ne,{sourceFile:e,onEdit:w,onRequestAvailableInserts:f,availableInserts:a,selectedNodeId:o,selectedKey:s,parentNodeInfo:d,setSelectedNodeId:l,setSelectedKey:g,setParentNodeInfo:p,children:[n.jsx(O,{}),n.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"1rem"},children:e==null?void 0:e.code.map((u,r)=>n.jsx(M,{node:u,children:n.jsx(I,{node:u,parentInfo:v(e,"code",r)})},u.id))})]}):n.jsx("p",{children:"loading..."}),m&&n.jsxs("div",{children:[n.jsx("h1",{children:"Debug Info"}),n.jsxs("p",{children:["selectedNodeId: ",o]}),n.jsxs("p",{children:["selectedKey: ",s]}),n.jsxs("p",{children:["parentNodeId: ",d==null?void 0:d.parent.id]}),n.jsxs("p",{children:["parentKey: ",d==null?void 0:d.key]}),n.jsxs("p",{children:["parentIndex: ",d==null?void 0:d.index]})]})]})})}B.createRoot(document.getElementById("root")).render(n.jsx(y.StrictMode,{children:n.jsx(oe,{})}));
