import{b as y,j as t,R as I,c as L}from"./client.js";const R=y.createContext(null);function h(){const e=y.useContext(R);if(!e)throw new Error("LineContext must be used inside a provider");return e}function M(e){const n=new Map,a=new Map;function i(s,p=null,u="",x=0){if(s)switch(n.set(s.id,s),p&&a.set(s.id,{parent:p,key:u,index:x}),s.type){case"FunctionDeclaration":{const r=s;r.params.forEach((c,o)=>i(c,r,"params",o));break}case"FunctionDefinition":{const r=s;r.params.forEach((c,o)=>i(c,r,"params",o)),i(r.body,s,"body",0);break}case"CompoundStatement":{s.statements.forEach((c,o)=>i(c,s,"statements",o));break}case"Declaration":{const r=s;r.initializer&&i(r.initializer,r,"initializer",0);break}case"ReturnStatement":{const r=s;r.expression&&i(r.expression,r,"expression",0);break}case"CallExpression":{const r=s;i(r,r,"calle",0),r.args.forEach((c,o)=>i(c,r,"args",o));break}case"AssignmentExpression":{i(s.value,s,"value",0);break}}}return e.forEach(s=>i(s)),{nodeMap:n,parentMap:a}}function P({ast:e,onEdit:n,selectedNodeId:a,selectedKey:i,setSelectedNodeId:s,setSelectedKey:p,insertTargetId:u,setInsertTargetId:x,children:r}){const{nodeMap:c,parentMap:o}=y.useMemo(()=>M(e),[e]);return t.jsx(R.Provider,{value:{onEdit:n,selectedNodeId:a,selectedKey:i,setSelectedNodeId:s,setSelectedKey:p,nodeMap:c,parentMap:o,insertTargetId:u,setInsertTargetId:x},children:r})}function m(e,n){const{selectedNodeId:a,selectedKey:i,onEdit:s,setSelectedNodeId:p,setSelectedKey:u}=h(),x=a==e.id&&i&&i==n,[r,c]=I.useState(String(e[n]??""));return I.useEffect(()=>{c(String(e[n]??""))},[e,n]),t.jsx("input",{className:"inline-editor",style:{...x?{backgroundColor:"rgba(255, 255, 255, 0.05)",boxShadow:"inset 0 -1px 0 0 rgba(163, 209, 252, 0.5)"}:{}},value:r,size:Math.max(1,r.length),onChange:o=>c(o.target.value),onFocus:o=>{u(n),p(e.id)},onBlur:()=>{e[n]=r,s(e,n)}})}function b({indent:e,node:n,children:a}){const{selectedNodeId:i,setSelectedNodeId:s,insertTargetId:p,setInsertTargetId:u,onEdit:x,nodeMap:r,parentMap:c}=h(),o=i===n.id,g=p===n.id,D=j=>{o&&j.key==="Enter"&&(j.preventDefault(),u(n.id))},S=j=>{if(!n)return;let d;switch(j){case"Declaration":{const l={id:crypto.randomUUID(),type:"StringLiteral",value:""};d={id:crypto.randomUUID(),type:"Declaration",data_type:"",name:"",initializer:l};break}case"ReturnStatement":{d={id:crypto.randomUUID(),type:"ReturnStatement",expression:void 0};break}case"UnknownNode":{d={id:crypto.randomUUID(),type:"UnknownNode",contents:""};break}case"PreprocInclude":{d={id:crypto.randomUUID(),type:"PreprocInclude",directive:""};break}case"FunctionParameter":{d={id:crypto.randomUUID(),type:"FunctionParameter",name:"",data_type:""};break}case"FunctionDeclaration":{d={id:crypto.randomUUID(),type:"FunctionDeclaration",name:"",return_type:"",params:[]};break}case"FunctionDefinition":{d={id:crypto.randomUUID(),type:"FunctionDefinition",name:"",return_type:"",params:[],body:{id:crypto.randomUUID(),type:"CompoundStatement",statements:[]}};break}case"CompoundStatement":{d={id:crypto.randomUUID(),type:"CompoundStatement",statements:[]};break}case"CallExpression":{d={id:crypto.randomUUID(),type:"CallExpression",identifier:"",idDeclaration:"",args:[]};break}case"Reference":{d={id:crypto.randomUUID(),type:"Reference",DeclRefId:""};break}case"AssignmentExpression":{d={id:crypto.randomUUID(),type:"AssignmentExpression",id_reference:"",value:{id:crypto.randomUUID(),type:"StringLiteral",value:""}};break}case"NumberLiteral":{d={id:crypto.randomUUID(),type:"NumberLiteral",value:""};break}case"StringLiteral":{d={id:crypto.randomUUID(),type:"StringLiteral",value:""};break}}const F=c.get(n.id);if(!F)return;const{parent:f,key:v,index:E}=F;if(!f||!("statements"in f))return;const U=f.statements,N=[...U.slice(0,E+1),d,...U.slice(E+1)];f.statements=N,r.set(d.id,d),c.set(d.id,{parent:f,key:v,index:E+1}),u(null),x(f,null)};return t.jsxs("div",{tabIndex:0,onClick:()=>s(n.id),onKeyDown:D,style:{backgroundColor:o?"rgba(116, 116, 116, 0.05)":"transparent"},children:[t.jsxs("div",{style:{whiteSpace:"pre-wrap",fontFamily:"monospace"},children:["    ".repeat(e),a]}),g&&t.jsxs("div",{style:{border:"1px solid #ccc",background:"black",position:"absolute"},children:[t.jsx("div",{onClick:()=>S("Declaration"),children:"Declaration"}),t.jsx("div",{onClick:()=>S("ReturnStatement"),children:"ReturnStatement"})]})]})}function w({node:e,indent:n}){switch(e.type){case"PreprocInclude":return t.jsx(_,{includeDecl:e,indent:n});case"FunctionParameter":return t.jsx(k,{paramDecl:e});case"FunctionDeclaration":throw new Error("Not implemented");case"FunctionDefinition":return t.jsx(A,{funcDef:e,indent:n});case"Declaration":return t.jsx(z,{varDecl:e,indent:n});case"ReturnStatement":return t.jsx(K,{returnStmt:e,indent:n});case"CompoundStatement":return t.jsx(C,{compStmt:e,indent:n});case"CallExpression":return t.jsx(T,{callExpr:e});case"Reference":return t.jsx(V,{declRefExpr:e});case"AssignmentExpression":return t.jsx(O,{assignmentExpr:e});case"NumberLiteral":return t.jsx(B,{literalExpr:e});case"StringLiteral":return t.jsx(W,{literalExpr:e});default:return"WIP"}}function _({includeDecl:e,indent:n}){return t.jsx(b,{indent:n,node:e,children:t.jsxs(t.Fragment,{children:["#include ","<",m(e,"directive"),">",";"]})})}function A({funcDef:e,indent:n}){const{nodeMap:a}=h();return a.set(e.id,e),t.jsxs(t.Fragment,{children:[t.jsx(b,{indent:n,node:e,children:t.jsxs(t.Fragment,{children:[m(e,"return_type"),m(e,"name"),"(",e.params.map((i,s)=>t.jsxs(I.Fragment,{children:[s>0&&", ",t.jsx(k,{paramDecl:i})]},i.id)),")","{"]})}),e.body&&t.jsx(C,{compStmt:e.body,indent:n+1}),t.jsx(b,{indent:n,node:e,children:"}"})]})}function z({varDecl:e,indent:n}){const{nodeMap:a}=h();return a.set(e.id,e),t.jsxs(b,{indent:n,node:e,children:[m(e,"data_type"),m(e,"name"),e.initializer&&t.jsxs(t.Fragment,{children:["= ",t.jsx(w,{node:e.initializer,indent:n})]}),";"]})}function k({paramDecl:e}){const{nodeMap:n}=h();return n.set(e.id,e),t.jsxs(t.Fragment,{children:[m(e,"data_type"),m(e,"name")]})}function C({compStmt:e,indent:n}){return e.statements.map(a=>t.jsx(w,{node:a,indent:n}))}function K({returnStmt:e,indent:n}){return t.jsxs(b,{indent:n,node:e,children:["return",e.expression&&t.jsxs(t.Fragment,{children:[" ",t.jsx(w,{node:e.expression,indent:0})]}),";"]})}function T({callExpr:e}){return t.jsxs(t.Fragment,{children:[m(e,"identifier"),"(",e.args.map((n,a)=>t.jsxs(I.Fragment,{children:[a>0&&", ",t.jsx(w,{node:n,indent:0})]},n.id)),");"]})}function V({declRefExpr:e}){const{nodeMap:n}=h(),a=n.get(e.DeclRefId);return!a||!("name"in a)?t.jsx(t.Fragment,{children:e.DeclRefId}):t.jsx(t.Fragment,{children:a.name})}function O({assignmentExpr:e}){return t.jsxs(t.Fragment,{children:["TODO assignmentExpr. node id: ",e.id]})}function B({literalExpr:e}){return t.jsx(t.Fragment,{children:m(e,"value")})}function W({literalExpr:e}){return t.jsx(t.Fragment,{children:m(e,"value")})}function $(){const[e,n]=y.useState([]),[a,i]=y.useState(null),[s,p]=y.useState(null),[u,x]=y.useState(null),c=[{id:"0",name:"main",type:"FunctionDefinition",return_type:"int",params:[{type:"FunctionParameter",id:"1",name:"argv",data_type:"int"}],body:{id:"2",type:"CompoundStatement",statements:[{id:"3",type:"Declaration",name:"myVar",data_type:"int",initializer:{id:"4",type:"NumberLiteral",value:"58"}}]}}];y.useEffect(()=>{n(c)},[]);const o=(g,D)=>{const S={type:"nodeEdit",contents:g,key:D};n(j=>[...j]),console.log("sending message: ",S)};return t.jsxs(t.Fragment,{children:[t.jsx(P,{ast:e,onEdit:o,selectedNodeId:a,selectedKey:s,setSelectedNodeId:i,setSelectedKey:p,insertTargetId:u,setInsertTargetId:x,children:t.jsx("div",{children:e.map(g=>t.jsx(w,{node:g,indent:0},g.id))})}),t.jsxs("div",{children:[t.jsx("h1",{children:"Debug Info"}),t.jsxs("p",{children:["selectedNodeId: ",a]}),t.jsxs("p",{children:["selectedKey: ",s]}),t.jsxs("p",{children:["insertTargetId: ",u]})]})]})}L.createRoot(document.getElementById("root")).render(t.jsx(y.StrictMode,{children:t.jsx($,{})}));
