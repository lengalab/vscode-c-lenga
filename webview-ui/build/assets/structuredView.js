import{b as x,j as t,R as y,c as L}from"./client.js";import{v as V}from"./vscode.js";const v=x.createContext(null);function j(){const e=x.useContext(v);if(!e)throw new Error("LineContext must be used inside a provider");return e}function z(e){const n=new Map,a=new Map;function i(s,o=null,l="",c=0){if(s)switch(n.set(s.id,s),o&&a.set(s.id,{parent:o,key:l,index:c}),s.type){case"FuncDecl":{const r=s;r.params.forEach((d,p)=>i(d,r,"params",p)),r.body&&i(r.body,s,"body",0);break}case"CompStmt":{s.statements.forEach((d,p)=>i(d,s,"statements",p));break}case"VarDecl":{const r=s;r.initializer&&i(r.initializer,r,"initializer",0);break}case"ReturnStmt":{const r=s;r.expression&&i(r.expression,r,"expression",0);break}case"CallExpr":{const r=s;i(r.calle,r,"calle",0),r.args.forEach((d,p)=>i(d,r,"args",p));break}case"AssignmentExpr":{const r=s;i(r.left,s,"left",0),i(r.right,s,"right",0);break}}}return e.forEach(s=>i(s)),{nodeMap:n,parentMap:a}}function N({ast:e,onEdit:n,selectedNodeId:a,setSelectedNodeId:i,insertTargetId:s,setInsertTargetId:o,children:l}){const{nodeMap:c,parentMap:r}=x.useMemo(()=>z(e),[e]);return t.jsx(v.Provider,{value:{onEdit:n,selectedNodeId:a,setSelectedNodeId:i,nodeMap:c,parentMap:r,insertTargetId:s,setInsertTargetId:o},children:l})}function u(e,n){const{onEdit:a}=j(),[i,s]=y.useState(String(e[n]??""));return y.useEffect(()=>{s(String(e[n]??""))},[e,n]),t.jsx("input",{className:"inline-editor",value:i,size:Math.max(1,i.length),onChange:o=>s(o.target.value),onInput:o=>{const l=o.target;l.size=Math.max(1,l.value.length)},onBlur:()=>{e[n]=i,a(e)}})}function h({indent:e,node:n,children:a}){const{selectedNodeId:i,setSelectedNodeId:s,insertTargetId:o,setInsertTargetId:l,onEdit:c,nodeMap:r,parentMap:d}=j(),p=i===n.id,w=o===n.id,C=E=>{p&&E.key==="Enter"&&(E.preventDefault(),l(n.id))},I=E=>{if(!n)return;let m;E==="VarDecl"?m={id:crypto.randomUUID(),type:"VarDecl",data_type:"",name:"",initializer:{id:crypto.randomUUID(),type:"LiteralExpr",value:""}}:m={id:crypto.randomUUID(),type:"ReturnStmt",expression:void 0};const S=d.get(n.id);if(!S)return;const{parent:f,key:D,index:R}=S;if(!f||!("statements"in f))return;const b=f.statements,k=[...b.slice(0,R+1),m,...b.slice(R+1)];f.statements=k,r.set(m.id,m),d.set(m.id,{parent:f,key:D,index:R+1}),l(null),c(f)};return t.jsxs("div",{tabIndex:0,onClick:()=>s(n.id),onKeyDown:C,style:{backgroundColor:p?"rgba(0,120,215,0.2)":"transparent"},children:[t.jsxs("div",{style:{whiteSpace:"pre-wrap",fontFamily:"monospace"},children:["    ".repeat(e),a]}),w&&t.jsxs("div",{style:{border:"1px solid #ccc",background:"black",position:"absolute"},children:[t.jsx("div",{onClick:()=>I("VarDecl"),children:"VarDecl"}),t.jsx("div",{onClick:()=>I("ReturnStmt"),children:"ReturnStmt"})]})]})}function g({node:e,indent:n}){switch(e.type){case"IncludeDecl":return t.jsx(A,{includeDecl:e,indent:n});case"FuncDecl":return t.jsx(U,{funcDecl:e,indent:n});case"VarDecl":return t.jsx(P,{varDecl:e,indent:n});case"ParamDecl":return t.jsx(F,{paramDecl:e});case"CompStmt":return t.jsx(M,{compStmt:e,indent:n});case"ReturnStmt":return t.jsx(T,{returnStmt:e,indent:n});case"CallExpr":return t.jsx(_,{callExpr:e});case"DeclRefExpr":return t.jsx(B,{declRefExpr:e});case"AssignmentExpr":return t.jsx(K,{assignmentExpr:e});case"LiteralExpr":return t.jsx(O,{literalExpr:e});case"IdentifierExpr":return t.jsx(W,{identifierExpr:e});default:return"WIP"}}function A({includeDecl:e,indent:n}){return t.jsx(h,{indent:n,node:e,children:t.jsxs(t.Fragment,{children:["#include ","<",u(e,"directive"),">",";"]})})}function U({funcDecl:e,indent:n}){const{nodeMap:a}=j();return a.set(e.id,e),t.jsxs(t.Fragment,{children:[t.jsx(h,{indent:n,node:e,children:t.jsxs(t.Fragment,{children:[u(e,"return_type"),u(e,"name"),"(",e.params.map((i,s)=>t.jsxs(y.Fragment,{children:[s>0&&", ",t.jsx(F,{paramDecl:i})]},i.id)),")","{"]})}),e.body&&t.jsx(M,{compStmt:e.body,indent:n+1}),t.jsx(h,{indent:n,node:e,children:"}"})]})}function P({varDecl:e,indent:n}){const{nodeMap:a}=j();return a.set(e.id,e),t.jsxs(h,{indent:n,node:e,children:[u(e,"data_type"),u(e,"name"),e.initializer&&t.jsxs(t.Fragment,{children:["= ",t.jsx(g,{node:e.initializer,indent:n})]}),";"]})}function F({paramDecl:e}){const{nodeMap:n}=j();return n.set(e.id,e),t.jsxs(t.Fragment,{children:[u(e,"data_type"),u(e,"name")]})}function M({compStmt:e,indent:n}){return e.statements.map(a=>t.jsx(g,{node:a,indent:n}))}function T({returnStmt:e,indent:n}){return t.jsxs(h,{indent:n,node:e,children:["return",e.expression&&t.jsxs(t.Fragment,{children:[" ",t.jsx(g,{node:e.expression,indent:0})]}),";"]})}function _({callExpr:e}){return t.jsxs(t.Fragment,{children:[t.jsx(g,{node:e.calle,indent:0}),"(",e.args.map((n,a)=>t.jsxs(y.Fragment,{children:[a>0&&", ",t.jsx(g,{node:n,indent:0})]},n.id)),");"]})}function B({declRefExpr:e}){const{nodeMap:n}=j(),a=n.get(e.DeclRefId);return!a||!("name"in a)?t.jsx(t.Fragment,{children:e.DeclRefId}):t.jsx(t.Fragment,{children:a.name})}function K({assignmentExpr:e}){return t.jsxs(t.Fragment,{children:["TODO assignmentExpr. node id: ",e.id]})}function O({literalExpr:e}){return t.jsx(t.Fragment,{children:u(e,"value")})}function W({identifierExpr:e}){return t.jsx(t.Fragment,{children:u(e,"identifier")})}function q(){const[e,n]=x.useState([]),[a,i]=x.useState(null),[s,o]=x.useState(null);x.useEffect(()=>{const c=r=>{const d=r.data;n(d.contents)};return window.addEventListener("message",c),V.postMessage({type:"ready"}),()=>{window.removeEventListener("message",c)}},[]);const l=c=>{const r={type:"nodeEdit",contents:c};n(d=>[...d]),console.log("sending message: ",r)};return t.jsx(N,{ast:e,onEdit:l,selectedNodeId:a,setSelectedNodeId:i,insertTargetId:s,setInsertTargetId:o,children:t.jsx("div",{children:e.map(c=>t.jsx(g,{node:c,indent:0},c.id))})})}L.createRoot(document.getElementById("root")).render(t.jsx(x.StrictMode,{children:t.jsx(q,{})}));
