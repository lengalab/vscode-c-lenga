import{b as m,j as n,R as I,c as N}from"./client.js";import{v as k}from"./vscode.js";const v=m.createContext(null);function j(){const e=m.useContext(v);if(!e)throw new Error("LineContext must be used inside a provider");return e}function P(e){return{nodeMap:new Map,parentMap:new Map}}function d(e,t){const{selectedNodeId:r,selectedKey:i,onEdit:c,setSelectedNodeId:x,setSelectedKey:u}=j(),g=r==e.id&&i&&i==t,[p,a]=I.useState(String(e[t]??""));return I.useEffect(()=>{a(String(e[t]??""))},[e,t]),n.jsx("input",{className:"inline-editor",style:{...g?{backgroundColor:"rgba(255, 255, 255, 0.05)",boxShadow:"inset 0 -1px 0 0 rgba(163, 209, 252, 0.5)"}:{}},value:p,size:Math.max(1,p.length),onChange:l=>a(l.target.value),onFocus:()=>{u(t),x(e.id)},onBlur:()=>{e[t]=p,c(e,t)}})}function h({indent:e,node:t,children:r}){const{selectedNodeId:i,setSelectedNodeId:c,insertTargetId:x,setInsertTargetId:u,onEdit:g,nodeMap:p,parentMap:a}=j(),l=i===t.id,y=x===t.id,F=b=>{l&&b.key==="Enter"&&(b.preventDefault(),u(t.id))},E=b=>{if(!t)return;let s;switch(b){case"Declaration":{const o={id:crypto.randomUUID(),type:"StringLiteral",value:""};s={id:crypto.randomUUID(),type:"Declaration",data_type:"",name:"",initializer:o};break}case"ReturnStatement":{s={id:crypto.randomUUID(),type:"ReturnStatement",expression:void 0};break}case"UnknownNode":{s={id:crypto.randomUUID(),type:"UnknownNode",contents:""};break}case"PreprocInclude":{s={id:crypto.randomUUID(),type:"PreprocInclude",directive:""};break}case"FunctionParameter":{s={id:crypto.randomUUID(),type:"FunctionParameter",name:"",data_type:""};break}case"FunctionDeclaration":{s={id:crypto.randomUUID(),type:"FunctionDeclaration",name:"",return_type:"",params:[]};break}case"FunctionDefinition":{s={id:crypto.randomUUID(),type:"FunctionDefinition",name:"",return_type:"",params:[],body:{id:crypto.randomUUID(),type:"CompoundStatement",statements:[]}};break}case"CompoundStatement":{s={id:crypto.randomUUID(),type:"CompoundStatement",statements:[]};break}case"CallExpression":{s={id:crypto.randomUUID(),type:"CallExpression",identifier:"",idDeclaration:"",args:[]};break}case"Reference":{s={id:crypto.randomUUID(),type:"Reference",DeclRefId:""};break}case"AssignmentExpression":{s={id:crypto.randomUUID(),type:"AssignmentExpression",id_reference:"",value:{id:crypto.randomUUID(),type:"StringLiteral",value:""}};break}case"NumberLiteral":{s={id:crypto.randomUUID(),type:"NumberLiteral",value:""};break}case"StringLiteral":{s={id:crypto.randomUUID(),type:"StringLiteral",value:""};break}case"SourceFile":throw new Error("Unimplemented")}const R=a.get(t.id);if(!R)return;const{parent:w,key:M,index:f}=R;if(!w||!("statements"in w))return;const D=w.statements,L=[...D.slice(0,f+1),s,...D.slice(f+1)];w.statements=L,p.set(s.id,s),a.set(s.id,{parent:w,key:M,index:f+1}),u(null),g(w,null)};return n.jsxs("div",{tabIndex:0,onClick:()=>c(t.id),onKeyDown:F,style:{backgroundColor:l?"rgba(116, 116, 116, 0.05)":"transparent"},children:[n.jsxs("div",{style:{whiteSpace:"pre-wrap",fontFamily:"monospace"},children:["    ".repeat(e),r]}),y&&n.jsxs("div",{style:{border:"1px solid #ccc",background:"black",position:"absolute"},children:[n.jsx("div",{onClick:()=>E("Declaration"),children:"Declaration"}),n.jsx("div",{onClick:()=>E("ReturnStatement"),children:"ReturnStatement"})]})]})}function S({node:e,indent:t}){switch(e.type){case"PreprocInclude":return n.jsx(A,{includeDecl:e,indent:t});case"FunctionParameter":return n.jsx(U,{paramDecl:e});case"FunctionDeclaration":return n.jsx(_,{functionDeclaration:e,indent:t});case"FunctionDefinition":return n.jsx(K,{funcDef:e,indent:t});case"Declaration":return n.jsx(T,{varDecl:e,indent:t});case"ReturnStatement":return n.jsx(z,{returnStmt:e,indent:t});case"CompoundStatement":return n.jsx(C,{compStmt:e,indent:t});case"CallExpression":return n.jsx(O,{callExpr:e});case"Reference":return n.jsx(V,{declRefExpr:e});case"AssignmentExpression":return n.jsx(B,{assignmentExpr:e});case"NumberLiteral":return n.jsx(H,{literalExpr:e});case"StringLiteral":return n.jsx(W,{literalExpr:e});default:return"WIP"}}function A({includeDecl:e,indent:t}){return n.jsx(h,{indent:t,node:e,children:n.jsxs(n.Fragment,{children:["#include ","<",d(e,"directive"),">",";"]})})}function _({functionDeclaration:e,indent:t}){const{nodeMap:r}=j();return r.set(e.id,e),n.jsx(n.Fragment,{children:n.jsx(h,{indent:t,node:e,children:n.jsxs(n.Fragment,{children:[d(e,"return_type"),d(e,"name"),"(",e.params.map((i,c)=>n.jsxs(I.Fragment,{children:[c>0&&", ",n.jsx(U,{paramDecl:i})]},i.id)),")"]})})})}function K({funcDef:e,indent:t}){const{nodeMap:r}=j();return r.set(e.id,e),n.jsxs(n.Fragment,{children:[n.jsx(h,{indent:t,node:e,children:n.jsxs(n.Fragment,{children:[d(e,"return_type"),d(e,"name"),"(",e.params.map((i,c)=>n.jsxs(I.Fragment,{children:[c>0&&", ",n.jsx(U,{paramDecl:i})]},i.id)),")","{"]})}),e.body&&n.jsx(C,{compStmt:e.body,indent:t+1}),n.jsx(h,{indent:t,node:e,children:"}"})]})}function T({varDecl:e,indent:t}){const{nodeMap:r}=j();return r.set(e.id,e),n.jsxs(h,{indent:t,node:e,children:[d(e,"data_type"),d(e,"name"),e.initializer&&n.jsxs(n.Fragment,{children:["= ",n.jsx(S,{node:e.initializer,indent:t})]}),";"]})}function U({paramDecl:e}){const{nodeMap:t}=j();return t.set(e.id,e),n.jsxs(n.Fragment,{children:[d(e,"data_type"),d(e,"name")]})}function C({compStmt:e,indent:t}){return e.statements.map(r=>n.jsx(S,{node:r,indent:t}))}function z({returnStmt:e,indent:t}){return n.jsxs(h,{indent:t,node:e,children:["return",e.expression&&n.jsxs(n.Fragment,{children:[" ",n.jsx(S,{node:e.expression,indent:0})]}),";"]})}function O({callExpr:e}){return n.jsxs(n.Fragment,{children:[d(e,"identifier"),"(",e.args.map((t,r)=>n.jsxs(I.Fragment,{children:[r>0&&", ",n.jsx(S,{node:t,indent:0})]},t.id)),");"]})}function V({declRefExpr:e}){const{nodeMap:t}=j(),r=t.get(e.DeclRefId);return!r||!("name"in r)?n.jsx(n.Fragment,{children:e.DeclRefId}):n.jsx(n.Fragment,{children:r.name})}function B({assignmentExpr:e}){return n.jsxs(n.Fragment,{children:["TODO assignmentExpr. node id: ",e.id]})}function H({literalExpr:e}){return n.jsx(n.Fragment,{children:d(e,"value")})}function W({literalExpr:e}){return n.jsx(n.Fragment,{children:d(e,"value")})}function $({ast:e,onEdit:t,selectedNodeId:r,selectedKey:i,setSelectedNodeId:c,setSelectedKey:x,insertTargetId:u,setInsertTargetId:g,children:p}){const{nodeMap:a,parentMap:l}=m.useMemo(()=>P(),[e]);return n.jsx(v.Provider,{value:{onEdit:t,selectedNodeId:r,selectedKey:i,setSelectedNodeId:c,setSelectedKey:x,nodeMap:a,parentMap:l,insertTargetId:u,setInsertTargetId:g},children:p})}function q(){const[e,t]=m.useState([]),[r,i]=m.useState(null),[c,x]=m.useState(null),[u,g]=m.useState(null);m.useEffect(()=>{const a=l=>{const y=l.data;console.log("Handling Message:",y.contents),t(y.contents)};return window.addEventListener("message",a),k.postMessage({type:"ready"}),()=>{window.removeEventListener("message",a)}},[]);const p=(a,l)=>{const y={type:"nodeEdit",contents:a,key:l};t(F=>[...F]),console.log("sending message: ",y)};return n.jsxs(n.Fragment,{children:[n.jsx($,{ast:e,onEdit:p,selectedNodeId:r,selectedKey:c,setSelectedNodeId:i,setSelectedKey:x,insertTargetId:u,setInsertTargetId:g,children:n.jsx("div",{children:e.map(a=>n.jsx(S,{node:a,indent:0},a.id))})}),n.jsxs("div",{children:[n.jsx("h1",{children:"Debug Info"}),n.jsxs("p",{children:["selectedNodeId: ",r]}),n.jsxs("p",{children:["selectedKey: ",c]}),n.jsxs("p",{children:["insertTargetId: ",u]})]})]})}N.createRoot(document.getElementById("root")).render(n.jsx(m.StrictMode,{children:n.jsx(q,{})}));
